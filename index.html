<!doctype html>
<head>
	<title>Transformer.js &bull; Sandbox</title>
	<meta charset="UTF-8">
	<link href="transformer.css" type="text/css" rel="stylesheet" />
	<style> 
		@font-face {
			font-family: 'proxima-nova';
			font-weight: 700;
			font-style: normal;
			src: url('http://chapel.at:8080/static/fonts/proximanova-bold-webfont.eot');
			src: url('http://chapel.at:8080/static/fonts/proximanova-bold-webfont.woff') format('woff'),
				 url('http://chapel.at:8080/static/fonts/proximanova-bold-webfont.eot?#iefix') format('embedded-opentype'),
				 url('http://chapel.at:8080/static/fonts/proximanova-bold-webfont.ttf') format('truetype'),
				 url('http://chapel.at:8080/static/fonts/proximanova-bold-webfont.svg#ProximaNova') format('svg');
		}
		body {
			padding: 0;
			margin: 0;
			background-color: #222;
			background-image: url(http://pcdn.500px.net/33177655/2e8805590feed907a839d2f7fb0342b426fc8ad0/4.jpg);
			background-size: cover;
			color: #fff;
		}
		.box {
			cursor: -webkit-grab;
			overflow: hidden;
			position: absolute;
			text-align: center;
			font-size: 50px;
			color: #fff;
			font-family: 'proxima-nova';
			font-weight: bold;
			text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
			word-wrap: break-word;
			-webkit-nbsp-mode: space;
			-webkit-line-break: after-white-space;
		}
		.box.selected {
			cursor: Transformer.VENDOR_PREFIX + '-grabbing';
			z-index: 999;
			outline: 2px solid rgba(0, 168, 219, 0.4);
		}
		.box.editable {
			-webkit-user-modify: read-write;
		}
	</style>
</head>
<body>
	<pre>
	Create box : SHIFT + DRAG
	Rotate box : CLICK TWICE IN BOCK 
	Double click : TO EDIT
	</pre>
<div class="box"
     style="
        position: absolute;
        left: 200px;
        top: 100px;
        width: 255px;
        height: 231px;
        -webkit-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -moz-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -o-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
     ">You can transform me!</div>

	<script src="vendor/mandox/esprima.js"></script>
	<script src="vendor/mandox/stacktrace.js"></script>
	<script src="vendor/mandox/mandox.js"></script>
	<script src="vendor/jquery.js"></script>
	<script src="math.js"></script>
	<script src="transformer.js"></script>
	<script>
		(function ($, math, Transformer) {
			var operation = null;
			var $selected = null;
			var start = null;
			var mode = 'move';

			function set_mode(new_mode) {
				mode = new_mode;
				switch (mode) {
					case 'move':
					return Transformer.style_markers('squares');
					case 'rotate':
					return Transformer.style_markers('circles');
					default:
					return Transformer.unmark();
				}
			}

			function mouseDownOnMarker(event) {
				var $marker = $(event.target);
				event.target = $selected[0];
				if ('rotate' === mode) {
					operation = Transformer.start('rotate', event);
				} else {
					operation = Transformer.start('resize', event, $marker);
					$selected.add('body').css('cursor', $marker.css('cursor'));
				}
			}

			function mouseDownOnElement(event) {
				if (!$selected || !$selected.is(event.target)) {
					$('.selected').removeClass('selected');
					set_mode('move');
					start = null;
				} else {
					if ('edit' === mode) {
						return;
					}
					start = [event.pageX, event.pageY];
				}
				$(event.target).addClass('selected');
				operation = Transformer.start(mode, event);
				Transformer.mark(operation[mode]);
			}

			function mouseDownOnDocument(event) {
				if (event.shiftKey) {
					set_mode('move');
					event.target = $('<div class="box"></div>').appendTo('body');
					operation = Transformer.start('create', event);
				}
				if (0 === $(event.target).closest('.box,.' + Transformer.MARKER_CLASS).length) {
					Transformer.unmark();
					if ($selected) {
						$selected.removeClass('selected').removeClass('editable');
					}
					$selected = null;
				}
			}

			function mouseUpOnDocument(event) {
				if (operation) {
					$selected = Transformer.end(operation).$element.css(
					'cursor',
					'-webkit-grab'
					);
					$('body').css('cursor', '');

					var has_moved = !start
					|| event.pageX !== start[0]
					|| event.pageY !== start[1];

					if (!has_moved) {
						set_mode(('rotate' === mode) ? 'move' : 'rotate');
					}
					operation = null;
				}
			}

			function mouseMoveOnDocument(event) {
				if (operation) {
					Transformer.mark(Transformer.update(operation, event));
				}
			}

			function dblClickOnElement(event) {
				if ('edit' !== mode) {
					set_mode('edit');
					$(event.target).addClass('editable');
				}
			}

			$(document)
				.on('mousedown', mouseDownOnDocument)
			    .on('mouseup', mouseUpOnDocument)
			    .on('mousemove', mouseMoveOnDocument)
			    .on('mousedown', '.' + Transformer.MARKER_CLASS, mouseDownOnMarker)
			    .on('mousedown', '.box', mouseDownOnElement)
			    .on('dblclick', '.box', dblClickOnElement);

			(function show_grid() {
				var size = 50;
				var w = $(window).width() + size;
				var h = $(window).height() + size;
				var rows = Math.ceil(h / size);
				var cols = Math.ceil(w / size);
				var i;
				$('.transformer-grid-line').remove();
				for (i = 0; i < rows; i++) {
					$('<div class="transformer-grid-line"></div>').css({
						position: 'absolute',
						borderTop: '1px dashed rgba(0,0,0,0.1)',
						width: w,
						height: 1,
						left: 0,
						top: size * i
					}).appendTo('body');
				}
				for (i = 0; i < cols; i++) {
					$('<div class="transformer-grid-line"></div>').css({
						position: 'absolute',
						borderLeft: '1px dashed rgba(0,0,0,0.1)',
						width: 1,
						height: h,
						left: size * i,
						top: 0
					}).appendTo('body');
				}
				var timer;
				$(window).resize(function () {
					if (timer) {
						clearTimeout(timer);
					}
					timer = setTimeout(show_grid, 200);
				});
			}());
		}(jQuery, MathUtil, Transformer));
	</script>
	<!--
	(</>).aloha(<})
	-->
</body>
</html>
