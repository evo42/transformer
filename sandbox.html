<!doctype html>
<head>
	<title>Transformer &bull; sandbox</title>
	<meta charset="UTF-8">
	<link href="transformer.css" type="text/css" rel="stylesheet" />
	<style> 
		body {
			padding: 0;
			margin: 0;
		}
		.transformer-element {
			cursor: -webkit-grab;
			overflow: hidden;
			position: absolute;
			text-align: center;
			border: 1px solid rgba(0,0,0,0.2);
			word-wrap: break-word;
			/* -webkit-user-modify: read-write; */
			-webkit-nbsp-mode: space;
			-webkit-line-break: after-white-space	
		}
	</style>
</head>
<body>
	<pre>
	   New box : SHIFT; DRAG
	Rotate box : CTRL; DRAG
	</pre>
<div class="transformer-element"
     style="
        position: absolute;
        left: 453px;
        top: 143px;
        width: 255px;
        height: 231px;
        -webkit-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -moz-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -o-transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
        -transform: matrix(0.9692254790162766, 0.2461746754352872, -0.2461746754352872, 0.9692254790162766, 0, 0);
     "></div>

	<script src="vendor/jquery.js"></script>
	<!-- script src="vendor/jquery-ui.js"></script -->
	<script src="vendor/mandox/esprima.js"></script>
	<script src="vendor/mandox/stacktrace.js"></script>
	<script src="vendor/mandox/mandox.js"></script>
	<script src="math.js"></script>
	<script src="transformer.js"></script>
	<script>
		(function ($, math, Transformer) {
			var operation = null;
			var $selected = null;

			function mouseDownOnMarker($event) {
				operation = Transformer.startResizing(
					$selected,
					$event.target,
					$event.pageX,
					$event.pageY
				);
			}

			function mouseDownOnElement($event) {
				$($event.target).css({
					cursor: Transformer.VENDOR_PREFIX + '-grabbing',
					zIndex: 999
				});
				if ($event.ctrlKey) {
					operation = Transformer.startRotating(
						$event.target,
						$event.pageX,
						$event.pageY
					);
					Transformer.mark(operation.rotate);
				} else {
					operation = Transformer.startMoving(
						$event.target,
						$event.pageX,
						$event.pageY
					);
					Transformer.mark(operation.move);
				}
			}

			function mouseDownOnDocument($event) {
				if ($event.shiftKey) {
					operation = Transformer.startCreating(
						$('<div class="transformer-element"></div>').appendTo('body'),
						$event.pageX,
						$event.pageY
					);
				}
				if (0 === $($event.target).closest('.transformer-element').length) {
					Transformer.unmark(operation);
				}
			}

			function mouseUpOnDocument($event) {
				if (operation) {
					$selected = Transformer.end(operation).$element.css(
						'cursor',
						'-webkit-grab'
					);
					operation = null;
				}
			}

			function mouseMoveOnDocument($event) {
				if (operation) {
					Transformer.mark(
						Transformer.update(
							operation,
							$event.pageX,
							$event.pageY
						)
					);
				}
			}

			$(document)
				.on('mousedown', mouseDownOnDocument)
			    .on('mouseup', mouseUpOnDocument)
			    .on('mousemove', mouseMoveOnDocument)
			    .on('mousedown', '.transformer-element', mouseDownOnElement)
			    .on('mousedown', '.transformer-marker', mouseDownOnMarker);

			(function show_grid() {
				var size = 50;
				var w = $(window).width() + size;
				var h = $(window).height() + size;
				var rows = Math.ceil(h / size);
				var cols = Math.ceil(w / size);
				var i;
				$('.transformer-grid-line').remove();
				for (i = 0; i < rows; i++) {
					$('<div class="transformer-grid-line"></div>').css({
						position: 'absolute',
						borderTop: '1px dashed rgba(0,0,0,0.1)',
						width: w,
						height: 1,
						left: 0,
						top: size * i
					}).appendTo('body');
				}
				for (i = 0; i < cols; i++) {
					$('<div class="transformer-grid-line"></div>').css({
						position: 'absolute',
						borderLeft: '1px dashed rgba(0,0,0,0.1)',
						width: 1,
						height: h,
						left: size * i,
						top: 0
					}).appendTo('body');
				}
				var timer;
				$(window).resize(function () {
					if (timer) {
						clearTimeout(timer);
					}
					timer = setTimeout(show_grid, 200);
				});
			}());
		}(jQuery, MathUtil, Transformer));
	</script>
</body>
</html>
